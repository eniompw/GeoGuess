<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuess Challenge</title>
    <script src="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.js"></script>
    <link href="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.css" rel="stylesheet" />
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f0f0f0; color: #333; }
        h1, #round-info { color: #2c3e50; }
        #mly, #game-container { width: 100%; max-width: 800px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #mly { height: 600px; overflow: hidden; }
        #game-container { background-color: white; padding: 20px; max-width: 600px; }
        #instructions, #round-info, #result { text-align: center; margin-bottom: 15px; }
        #round-info, #result { font-size: 1.2em; font-weight: bold; }
        #guess-form { display: flex; flex-direction: column; align-items: center; }
        #guess-input, .btn { width: 100%; max-width: 300px; padding: 10px; font-size: 1em; margin-bottom: 10px; border-radius: 5px; }
        #guess-input { border: 1px solid #ccc; }
        .btn { cursor: pointer; color: white; border: none; transition: background-color 0.3s ease; }
        #submit-guess { background-color: #3498db; }
        #submit-guess:hover { background-color: #2980b9; }
        #new-game-btn { background-color: #2ecc71; font-size: 1.1em; padding: 12px 24px; }
        #new-game-btn:hover { background-color: #27ae60; }
        #loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 20px; border-radius: 10px; font-size: 1.2em; z-index: 1000; display: none; }
        .ellipsis::after { content: '...'; animation: ellipsis-animation 1.5s infinite; display: inline-block; width: 0; overflow: hidden; }
        @keyframes ellipsis-animation { 0% { width: 0; } 25% { width: 0.25em; } 50% { width: 0.5em; } 75% { width: 0.75em; } 100% { width: 1em; } }
    </style>
</head>
<body>
    <h1>GeoGuess Challenge</h1>
    <div id="mly"></div>
    <div id="loading-indicator">Loading location<span class="ellipsis"></span></div>
    <div id="game-container">
        <div id="instructions">Guess the location! Enter either the capital city or the country name.<br>There are 5 rounds of increasing difficulty. Can you guess them all?</div>
        <div id="round-info">Round: <span id="current-round">1</span> / 5</div>
        <div id="guess-form">
            <input type="text" id="guess-input" placeholder="Enter a capital or country" disabled>
            <button id="submit-guess" class="btn" disabled>Submit Guess</button>
        </div>
        <div id="result"></div>
        <button id="new-game-btn" class="btn">New Game</button>
    </div>

    <script>
        const { Viewer } = mapillary;
        let viewer;
        const elements = {
            submitGuess: document.getElementById('submit-guess'),
            guessInput: document.getElementById('guess-input'),
            result: document.getElementById('result'),
            loadingIndicator: document.getElementById('loading-indicator'),
            currentRound: document.getElementById('current-round')
        };

        function initializeViewer(imageId) {
            if (viewer) viewer.remove();
            viewer = new Viewer({
                accessToken: 'API_KEY_HERE',
                container: 'mly',
                imageId: imageId,
            });
        }

        function toggleLoading(show) {
            elements.loadingIndicator.style.display = show ? 'flex' : 'none';
            elements.guessInput.disabled = elements.submitGuess.disabled = show;
        }

        function loadImage(retryCount = 0) {
            toggleLoading(true);
            fetch('/get_image')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    } else {
                        initializeViewer(data.image_id);
                        elements.currentRound.textContent = data.round;
                        elements.guessInput.disabled = elements.submitGuess.disabled = false;
                        elements.result.textContent = "";
                    }
                    toggleLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (retryCount < 2) {  // Try 3 times in total (0, 1, 2)
                        elements.result.textContent = `An error occurred while loading the image. Retrying... (Attempt ${retryCount + 2}/3)`;
                        elements.result.style.color = "orange";
                        setTimeout(() => loadImage(retryCount + 1), 2000);
                    } else {
                        elements.result.textContent = "Failed to load the image after 3 attempts. Trying a new location...";
                        elements.result.style.color = "orange";
                        setTimeout(() => loadImage(0), 2000);  // Reset retry count and try a new image
                    }
                });
        }

        function submitAnswer() {
            const guess = elements.guessInput.value.trim().toLowerCase();
            if (!guess) {
                elements.result.textContent = "Please enter a guess before submitting.";
                elements.result.style.color = "red";
                return;
            }
            elements.submitGuess.disabled = true;
            
            fetch('/guess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `guess=${encodeURIComponent(guess)}`
            })
            .then(response => response.json())
            .then(data => {
                elements.result.textContent = data.message;
                elements.result.style.color = data.correct ? "green" : "red";
                
                if (data.correct && data.next_round || (!data.correct && data.tries_reset)) {
                    setTimeout(function() {
                        toggleLoading(true);
                        setTimeout(function() {
                            if (data.correct && data.next_round) {
                                window.location.href = '/next_round';
                            } else {
                                initializeViewer(data.new_image);
                                elements.result.textContent = "New location loaded. Try again!";
                                elements.result.style.color = "black";
                                elements.guessInput.value = '';
                                toggleLoading(false);
                                elements.submitGuess.disabled = false;
                            }
                        }, 2000);
                    }, 1000);
                } else {
                    elements.guessInput.value = '';
                    elements.guessInput.focus();
                    elements.submitGuess.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                elements.result.textContent = "An error occurred. Please try again.";
                elements.result.style.color = "red";
                elements.submitGuess.disabled = false;
            });
        }

        window.addEventListener('load', loadImage);
        elements.submitGuess.addEventListener('click', submitAnswer);
        elements.guessInput.addEventListener('keyup', function(event) { 
            if (event.key === 'Enter') submitAnswer(); 
        });
        document.getElementById('new-game-btn').addEventListener('click', function() { 
            window.location.href = '/new_game'; 
        });
    </script>
</body>
</html>